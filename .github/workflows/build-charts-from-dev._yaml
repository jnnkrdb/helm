name: Build Charts from .dev
on:
  push:
    branches:
      - master
    paths:
      - '.dev/**'
      - '.github/workflows/*.yaml'
jobs:
  helm:
    runs-on: ubuntu-latest
    #strategy:
    #  matrix:
    #    chart:
    #      - .dev/argocd
    env:
      HELM_EXPERIMENTAL_OCI: 1 #enable OCI support
      HELM_DIR: .dev/
      HELM_URL: https://jnnkrdb.github.io/helm/
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
       
      - name: Update Dependencies
        run: |
          find $HELM_DIR -mindepth 1 -maxdepth 1 -type d \
            -exec echo 'Chart-Dir - {}' \; -exec helm dependency update {} --debug \;

      - name: Lint
        run: |
          find $HELM_DIR -mindepth 1 -maxdepth 1 -type d \
            -exec echo 'Lint: {}' \; -exec helm lint {} --debug \;

      - name: Package
        run: |
          find $HELM_DIR -mindepth 1 -maxdepth 1 -type d \
            -exec echo 'Package: {}' \; -exec helm package {} --destination ./charts/ \;

      - name: Git Upload Changes
        run: | 
          git remote set-url origin https://${{ secrets.REPO_TOKEN }}@github.com/${{ github.repository }}
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git add .
          git commit -m "uploaded new charts: $(date +"%Y-%m-%d - %H:%M:%S")"
          git push
